é€™æ˜¯ä¸€å€‹å®Œç¾çš„æŠ€è¡“å †ç–Šé¸æ“‡ï¼š**Hono + HTMX + Alpine.js + Pico.css**ã€‚

*   **Pico.css**: åŸç”Ÿèªæ„åŒ– HTML æ¨£å¼ï¼Œä¸ç”¨å¯« classï¼Œæ¥µè‡´è¼•é‡ã€‚
*   **HTMX**: å¯¦ç¾ Dashboard çš„å±€éƒ¨åˆ·æ–° (Polling)ï¼Œä¸éœ€è¦è¤‡é›œçš„ React Stateã€‚
*   **Alpine.js**: è™•ç†æ¥µå°‘é‡çš„å®¢æˆ¶ç«¯äº’å‹•ï¼ˆå¦‚ï¼šæŠŠ UTC æ™‚é–“è½‰æœ¬åœ°æ™‚é–“é¡¯ç¤ºï¼‰ã€‚
*   **Hono**: è™•ç†è·¯ç”±ã€SSR æ¸²æŸ“èˆ‡ API é‚è¼¯ã€‚

é€™å°‡æ˜¯ **Watch-Dog v2.0 (ä»£è™Ÿ: Sentinel)** çš„å®Œæ•´å¯¦ä½œã€‚

---

# ğŸš€ Project Sentinel: å®Œæ•´å¯¦ä½œè¨ˆç•«

## 1. å°ˆæ¡ˆçµæ§‹

```
watch-dog/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.tsx          # æ‡‰ç”¨ç¨‹å¼å…¥å£ (Hono app)
â”‚   â”œâ”€â”€ db.sql             # è³‡æ–™åº« Schema
â”‚   â”œâ”€â”€ components.tsx     # JSX å…ƒä»¶ (Dashboard UI)
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ alert.ts       # è­¦å ±é‚è¼¯ (Slack)
â”‚   â”‚   â””â”€â”€ logic.ts       # ç‹€æ…‹æ©Ÿé‚è¼¯ (åˆ¤æ–·é–¾å€¼/å†·å»)
â”‚   â””â”€â”€ client_example.py  # çµ¦å„å°ˆæ¡ˆç”¨çš„ Python ç¯„ä¾‹
â”œâ”€â”€ wrangler.toml          # Cloudflare è¨­å®š
â”œâ”€â”€ package.json
â””â”€â”€ tsconfig.json
```

## 2. æ ¸å¿ƒè³‡æ–™åº« (D1 Schema)

è«‹å°‡æ­¤å­˜ç‚º `src/db.sql`ã€‚

```sql
-- å°ˆæ¡ˆè¡¨ï¼šç®¡ç† Token èˆ‡ å…¨åŸŸç¶­è­·ç‹€æ…‹
CREATE TABLE IF NOT EXISTS projects (
    id TEXT PRIMARY KEY,           -- å°ˆæ¡ˆä»£ç¢¼ (ex: "topreview")
    token TEXT NOT NULL,           -- API é©—è­‰ Token (Bearer)
    display_name TEXT NOT NULL,
    slack_webhook TEXT,            -- å°ˆå±¬çš„ Slack Webhook (å¯é¸)
    maintenance_until INTEGER DEFAULT 0, -- Unix Timestamp
    created_at INTEGER DEFAULT (unixepoch())
);

-- æª¢æŸ¥é …ç›®è¡¨ï¼šå®šç¾©è¦å‰‡èˆ‡ç•¶å‰ç‹€æ…‹
CREATE TABLE IF NOT EXISTS checks (
    id TEXT PRIMARY KEY,           -- æ ¼å¼: "project_id:check_name"
    project_id TEXT NOT NULL,
    name TEXT NOT NULL,
    display_name TEXT,
    type TEXT NOT NULL,            -- 'heartbeat' (å®šæœŸ) æˆ– 'event' (äº‹ä»¶)
    
    -- è¦å‰‡ (SLA)
    interval INTEGER DEFAULT 300,  -- é æœŸå›å ±ç§’æ•¸
    grace INTEGER DEFAULT 60,      -- å¯¬é™ç§’æ•¸
    threshold INTEGER DEFAULT 1,   -- å ±è­¦é–¾å€¼ (é€£çºŒå¤±æ•—æ¬¡æ•¸)
    cooldown INTEGER DEFAULT 900,  -- å ±è­¦å†·å»æ™‚é–“ (ç§’)
    
    -- ç‹€æ…‹ (State)
    last_seen INTEGER DEFAULT 0,
    status TEXT DEFAULT 'ok',      -- 'ok', 'error', 'dead'
    failure_count INTEGER DEFAULT 0,
    last_alert_at INTEGER DEFAULT 0,
    last_message TEXT,
    
    FOREIGN KEY(project_id) REFERENCES projects(id)
);

-- æ—¥èªŒè¡¨ (å®šæœŸæ¸…ç†)
CREATE TABLE IF NOT EXISTS logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    check_id TEXT NOT NULL,
    status TEXT NOT NULL,
    latency INTEGER,
    message TEXT,
    created_at INTEGER DEFAULT (unixepoch())
);

-- ç´¢å¼•å„ªåŒ–æŸ¥è©¢é€Ÿåº¦
CREATE INDEX IF NOT EXISTS idx_checks_project ON checks(project_id);
CREATE INDEX IF NOT EXISTS idx_logs_check_id ON logs(check_id);
```

---

## 3. å®Œæ•´ç¨‹å¼ç¢¼å¯¦ä½œ

### è¨­å®šæª” `wrangler.toml`

```toml
name = "watch-dog"
main = "src/index.tsx"
compatibility_date = "2024-02-02"

[[d1_databases]]
binding = "DB"
database_name = "watch-dog-db"
database_id = "ä½ çš„-D1-ID-å¡«åœ¨é€™è£¡"

[triggers]
crons = ["* * * * *"] # æ¯åˆ†é˜åŸ·è¡Œä¸€æ¬¡å·¡é‚
```

### è­¦å ±æœå‹™ `src/services/alert.ts`

```typescript
// è² è²¬ç™¼é€ Slack é€šçŸ¥
export async function sendSlackAlert(webhookUrl: string, payload: any) {
  try {
    await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
  } catch (e) {
    console.error('Failed to send Slack alert', e);
  }
}

export function formatSlackMessage(level: string, title: string, details: string, checkId: string) {
  const color = level === 'CRITICAL' ? '#ff0000' : level === 'RECOVERY' ? '#36a64f' : '#ffcc00';
  return {
    attachments: [
      {
        color: color,
        title: `[${level}] ${title}`,
        text: details,
        footer: `Watch-Dog | ${checkId}`,
        ts: Math.floor(Date.now() / 1000)
      }
    ]
  };
}
```

### æ ¸å¿ƒé‚è¼¯èˆ‡ç‹€æ…‹æ©Ÿ `src/services/logic.ts`

é€™æ˜¯æ•´å€‹ç³»çµ±çš„**å¤§è…¦**ï¼Œè™•ç†é–¾å€¼ã€å†·å»èˆ‡éœéŸ³ã€‚

```typescript
import { D1Database } from '@cloudflare/workers-types';
import { sendSlackAlert, formatSlackMessage } from './alert';

// é è¨­çš„å…¨åŸŸ Slack Webhook (å¦‚æœå°ˆæ¡ˆæ²’è¨­å®šï¼Œå°±ç”¨é€™å€‹)
const GLOBAL_SLACK_WEBHOOK = "YOUR_DEFAULT_SLACK_WEBHOOK_URL"; 

export async function processCheckResult(
  db: D1Database,
  check: any,
  project: any,
  newStatus: 'ok' | 'error' | 'dead',
  message: string,
  latency: number = 0
) {
  const now = Math.floor(Date.now() / 1000);
  let failureCount = check.failure_count;
  let lastAlertAt = check.last_alert_at;
  let shouldAlert = false;
  let alertType = '';

  // 1. ç‹€æ…‹åˆ¤å®šé‚è¼¯
  if (newStatus === 'ok') {
    // å¦‚æœä¹‹å‰æ˜¯å£çš„ï¼Œä¸”ç´¯ç©æ¬¡æ•¸è¶…éé–¾å€¼(ä»£è¡¨å·²ç¶“å«éäº†)ï¼Œç¾åœ¨å¥½äº† -> ç™¼é€æ¢å¾©é€šçŸ¥
    if (check.status !== 'ok' && failureCount >= check.threshold) {
        alertType = 'RECOVERY';
        shouldAlert = true;
    }
    failureCount = 0; // é‡ç½®å¤±æ•—è¨ˆæ•¸
  } else {
    // ç™¼ç”ŸéŒ¯èª¤ (Error or Dead)
    failureCount++;
    
    // åˆ¤æ–·æ˜¯å¦ç™¼è­¦å ±ï¼š
    // A. å¿…é ˆä¸åœ¨ç¶­è­·æ¨¡å¼ä¸­
    // B. ç´¯ç©å¤±æ•—æ¬¡æ•¸ >= é–¾å€¼
    // C. è¶…éå†·å»æ™‚é–“
    const inMaintenance = project.maintenance_until > now;
    const hitThreshold = failureCount >= check.threshold;
    const cooldownPassed = (now - lastAlertAt) > check.cooldown;

    if (!inMaintenance && hitThreshold && cooldownPassed) {
      alertType = 'CRITICAL';
      shouldAlert = true;
      lastAlertAt = now; // æ›´æ–°æœ€å¾Œå ±è­¦æ™‚é–“
    }
  }

  // 2. æ›´æ–°è³‡æ–™åº«
  await db.prepare(`
    UPDATE checks SET 
      status = ?, 
      last_seen = ?, 
      failure_count = ?, 
      last_alert_at = ?,
      last_message = ?
    WHERE id = ?
  `).bind(newStatus, now, failureCount, lastAlertAt, message, check.id).run();

  // å¯« Log
  await db.prepare(`
    INSERT INTO logs (check_id, status, latency, message, created_at)
    VALUES (?, ?, ?, ?, ?)
  `).bind(check.id, newStatus, latency, message, now).run();

  // 3. ç™¼é€é€šçŸ¥
  if (shouldAlert) {
    const webhook = project.slack_webhook || GLOBAL_SLACK_WEBHOOK;
    const alertMsg = formatSlackMessage(
      alertType, 
      `${project.display_name}: ${check.display_name}`, 
      `${message} (Failures: ${failureCount})`,
      check.id
    );
    await sendSlackAlert(webhook, alertMsg);
  }
}
```

### ä¸»ç¨‹å¼ `src/index.tsx` (API + Dashboard)

é€™è£¡èåˆäº† API è™•ç†èˆ‡ Hono/Pico Dashboardã€‚

```tsx
import { Hono } from 'hono';
import { cors } from 'hono/cors';
import { html } from 'hono/html';
import { processCheckResult } from './services/logic';

type Bindings = {
  DB: D1Database;
};

const app = new Hono<{ Bindings: Bindings }>();

app.use('*', cors());

// --- UI Components (JSX) ---
const Layout = (props: { children: any; title?: string }) => html`
<!DOCTYPE html>
<html lang="zh-TW" data-theme="dark">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>${props.title || 'Watch-Dog Sentinel'}</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
  <script src="https://unpkg.com/htmx.org@1.9.10"></script>
  <script src="//unpkg.com/alpinejs" defer></script>
  <style>
    :root { --primary: #e63946; }
    .status-ok { color: #2ecc71; border-color: #2ecc71; }
    .status-error { color: #e74c3c; border-color: #e74c3c; }
    .status-dead { color: #95a5a6; border-color: #95a5a6; }
    .card-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
  </style>
</head>
<body class="container" style="padding-top: 2rem;">
  <nav>
    <ul>
      <li><strong>ğŸ¶ Watch-Dog Sentinel</strong></li>
    </ul>
    <ul>
      <li><a href="/" class="secondary">Refresh</a></li>
    </ul>
  </nav>
  <main id="main-content">
    ${props.children}
  </main>
</body>
</html>
`;

const ProjectCard = (project: any, checks: any[]) => {
  const isMaintenance = project.maintenance_until > Date.now() / 1000;
  
  return html`
  <article x-data="{ localTime(ts) { return new Date(ts * 1000).toLocaleString() } }">
    <header style="display:flex; justify-content:space-between; align-items:center;">
      <h3 style="margin:0">${project.display_name}</h3>
      ${isMaintenance ? html`<small data-tooltip="ç¶­è­·æ¨¡å¼ä¸­">ğŸš§</small>` : ''}
    </header>
    
    <table>
      <thead>
        <tr>
          <th>æª¢æŸ¥é …</th>
          <th>ç‹€æ…‹</th>
          <th>Last Seen</th>
        </tr>
      </thead>
      <tbody>
        ${checks.map(c => html`
          <tr>
            <td>
              <strong>${c.display_name}</strong><br>
              <small>${c.last_message || '-'}</small>
            </td>
            <td>
              ${c.status === 'ok' 
                ? html`<ins>OK</ins>` 
                : c.status === 'dead' 
                  ? html`<del>DEAD</del>` 
                  : html`<mark>ERR (${c.failure_count})</mark>`}
            </td>
            <td>
              <small x-text="localTime(${c.last_seen})"></small>
            </td>
          </tr>
        `)}
      </tbody>
    </table>
    
    <footer>
       <details>
        <summary>æ“ä½œ</summary>
        <div class="grid">
            <button class="secondary outline" 
                    hx-post="/api/maintenance/${project.id}?duration=600"
                    hx-swap="none"
                    onclick="alert('å·²é–‹å•Ÿç¶­è­·æ¨¡å¼ 10 åˆ†é˜')">
                ç¶­è­· 10m
            </button>
            <button class="contrast outline"
                    hx-post="/api/maintenance/${project.id}?duration=0"
                    hx-swap="none">
                è§£é™¤ç¶­è­·
            </button>
        </div>
       </details>
    </footer>
  </article>
`};

// --- Routes ---

// 1. Dashboard (HTMX Polling)
app.get('/', async (c) => {
  // å–å¾—è³‡æ–™
  const { results: projects } = await c.env.DB.prepare("SELECT * FROM projects ORDER BY id").all();
  const { results: checks } = await c.env.DB.prepare("SELECT * FROM checks ORDER BY id").all();
  
  // çµ„åˆè³‡æ–™
  const content = html`
    <div class="card-grid" hx-get="/" hx-trigger="every 30s" hx-select=".card-grid" hx-swap="outerHTML">
      ${projects.map((p: any) => {
        const pChecks = checks.filter((k: any) => k.project_id === p.id);
        return ProjectCard(p, pChecks);
      })}
    </div>
  `;

  // å¦‚æœæ˜¯ HTMX è«‹æ±‚ï¼Œåªå›å‚³å±€éƒ¨ï¼›å¦å‰‡å›å‚³å®Œæ•´é é¢
  if (c.req.header('HX-Request')) {
    return c.html(content);
  }
  return c.html(<Layout>{content}</Layout>);
});

// 2. API: è¨»å†Š/æ›´æ–°è¨­å®š (Upsert)
app.put('/api/config', async (c) => {
  const token = c.req.header('Authorization')?.split(' ')[1];
  if (!token) return c.json({ error: 'Unauthorized' }, 401);

  // é©—è­‰ Token ä¸¦å–å¾— Project ID
  const project = await c.env.DB.prepare("SELECT * FROM projects WHERE token = ?").bind(token).first();
  if (!project) return c.json({ error: 'Invalid Token' }, 403);

  const body = await c.req.json();
  const checks = body.checks || [];

  // Upsert Checks
  for (const check of checks) {
    const checkId = `${project.id}:${check.name}`;
    // æª¢æŸ¥æ˜¯å¦å­˜åœ¨
    const exists = await c.env.DB.prepare("SELECT 1 FROM checks WHERE id = ?").bind(checkId).first();
    
    if (exists) {
      await c.env.DB.prepare(`
        UPDATE checks SET display_name=?, type=?, interval=?, grace=?, threshold=?, cooldown=?
        WHERE id=?
      `).bind(check.display_name, check.type, check.interval, check.grace, check.threshold, check.cooldown, checkId).run();
    } else {
      await c.env.DB.prepare(`
        INSERT INTO checks (id, project_id, name, display_name, type, interval, grace, threshold, cooldown)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
      `).bind(checkId, project.id, check.name, check.display_name, check.type, check.interval, check.grace, check.threshold, check.cooldown).run();
    }
  }

  return c.json({ success: true, count: checks.length });
});

// 3. API: æ¥æ”¶å¿ƒè·³ (Pulse)
app.post('/api/pulse', async (c) => {
  const token = c.req.header('Authorization')?.split(' ')[1];
  if (!token) return c.json({ error: 'Unauthorized' }, 401);

  const project = await c.env.DB.prepare("SELECT * FROM projects WHERE token = ?").bind(token).first();
  if (!project) return c.json({ error: 'Invalid Token' }, 403);

  const body = await c.req.json();
  const checkId = `${project.id}:${body.check_name}`;
  
  const check = await c.env.DB.prepare("SELECT * FROM checks WHERE id = ?").bind(checkId).first();
  if (!check) return c.json({ error: 'Check not found (please register first)' }, 404);

  // è™•ç†é‚è¼¯ (Threshold, Cooldown, Alert)
  await processCheckResult(
    c.env.DB, 
    check, 
    project, 
    body.status === 'ok' ? 'ok' : 'error',
    body.message || '',
    body.latency || 0
  );

  return c.json({ success: true });
});

// 4. API: ç¶­è­·æ¨¡å¼
app.post('/api/maintenance/:projectId', async (c) => {
    const projectId = c.req.param('projectId');
    const duration = Number(c.req.query('duration')) || 0;
    const until = Math.floor(Date.now()/1000) + duration;
    
    await c.env.DB.prepare("UPDATE projects SET maintenance_until = ? WHERE id = ?")
        .bind(until, projectId).run();
        
    return c.json({ success: true, mode: duration > 0 ? 'maintenance' : 'active' });
});

export default app;

// --- Cron Trigger (æ­»äººé–‹é—œ) ---
export const scheduled = async (event: any, env: Bindings, ctx: any) => {
    const now = Math.floor(Date.now() / 1000);
    
    // æ‰¾å‡ºæ‰€æœ‰è¶…æ™‚çš„ Heartbeat Checks
    // æ¢ä»¶: é¡å‹æ˜¯ heartbeat AND (ä¸Šæ¬¡æ™‚é–“ + é€±æœŸ + å¯¬é™ < ç¾åœ¨) AND ç‹€æ…‹ä¸æ˜¯ dead
    const { results: deadChecks } = await env.DB.prepare(`
        SELECT c.*, p.maintenance_until, p.display_name as project_name, p.slack_webhook
        FROM checks c
        JOIN projects p ON c.project_id = p.id
        WHERE c.type = 'heartbeat' 
        AND c.status != 'dead'
        AND (c.last_seen + c.interval + c.grace) < ?
    `).bind(now).all();

    for (const check of deadChecks) {
        // æ¨¡æ“¬ä¸€å€‹ "Dead" çš„ Pulse
        const project = { 
            id: check.project_id, 
            display_name: check.project_name, 
            maintenance_until: check.maintenance_until,
            slack_webhook: check.slack_webhook
        };
        
        await processCheckResult(
            env.DB, 
            check, 
            project, 
            'dead', 
            `Heartbeat missed! Last seen: ${now - check.last_seen}s ago`
        );
    }
    
    // æ¸…ç†èˆŠ Logs (ä¿ç•™ 7 å¤©)
    await env.DB.prepare("DELETE FROM logs WHERE created_at < ?").bind(now - 604800).run();
};
```

---

## 4. Python Client (çµ¦å„å°ˆæ¡ˆç”¨)

é€™æ˜¯ä¸€å€‹æ¨™æº–çš„ Python SDK ç¯„ä¾‹ï¼Œè®“ä½ çš„ `topreview-edge` ç­‰å°ˆæ¡ˆä½¿ç”¨ã€‚

```python
# watchdog_client.py
import requests
import time
import functools

class WatchDog:
    def __init__(self, base_url, project_token):
        self.base_url = base_url
        self.token = project_token
        self.headers = {"Authorization": f"Bearer {project_token}"}

    def register(self, checks):
        """å•Ÿå‹•æ™‚å‘¼å«ï¼šè¨»å†Šæª¢æŸ¥é …ç›®"""
        payload = {"checks": checks}
        try:
            res = requests.put(f"{self.base_url}/api/config", json=payload, headers=self.headers)
            print(f"[WatchDog] Config synced: {res.status_code}")
        except Exception as e:
            print(f"[WatchDog] Register failed: {e}")

    def pulse(self, check_name, status="ok", message="OK", latency=0):
        """ç™¼é€å¿ƒè·³"""
        payload = {
            "check_name": check_name,
            "status": status,
            "message": message,
            "latency": latency
        }
        try:
            requests.post(f"{self.base_url}/api/pulse", json=payload, headers=self.headers, timeout=5)
        except Exception as e:
            # ç›£æ§ç³»çµ±ä¸èƒ½å½±éŸ¿ä¸»ç¨‹å¼ï¼Œåæ‰éŒ¯èª¤
            print(f"[WatchDog] Pulse failed: {e}")

# --- ä½¿ç”¨ç¯„ä¾‹ ---
if __name__ == "__main__":
    wd = WatchDog("https://watchdog.your-domain.com", "topreview-token-123")
    
    # 1. å•Ÿå‹•æ™‚è¨»å†Š (Upsert)
    wd.register([
        {
            "name": "worker_health",
            "display_name": "Worker Process Check",
            "type": "heartbeat",
            "interval": 60,
            "grace": 10,
            "threshold": 3,   # é€£çºŒéŒ¯3æ¬¡æ‰å«
            "cooldown": 600   # 10åˆ†é˜å…§ä¸é‡è¤‡å«
        }
    ])

    # 2. å®šæœŸå›å ±
    while True:
        start = time.time()
        # ... åšä½ çš„æª¢æŸ¥ ...
        # ... check_db_connection() ...
        
        latency = int((time.time() - start) * 1000)
        wd.pulse("worker_health", status="ok", latency=latency)
        print("Pulse sent")
        time.sleep(60)
```

---

## å¦‚ä½•é–‹å§‹ (åŸ·è¡Œæ­¥é©Ÿ)

1.  **åˆå§‹åŒ–**:
    `npm create cloudflare@latest watch-dog` (é¸æ“‡ Hono æ¨¡æ¿)ã€‚
2.  **å®‰è£ä¾è³´**:
    `npm install @picocss/pico alpinejs htmx.org` (å…¶å¯¦å‰ç«¯éƒ½ç”¨ CDN äº†ï¼Œé€™è£¡ä¸»è¦æ˜¯å¾Œç«¯çš„ type)ã€‚
3.  **è¨­å®š D1**:
    `npx wrangler d1 create watch-dog-db`
    æŠŠç”¢ç”Ÿçš„ ID è²¼åˆ° `wrangler.toml`ã€‚
4.  **å»ºç«‹ Table**:
    `npx wrangler d1 execute watch-dog-db --file=src/db.sql`
    *æ³¨æ„ï¼šä½ éœ€è¦æ‰‹å‹•å…ˆ Insert ä¸€ç­† Project è³‡æ–™é€²å»ï¼Œæ‰èƒ½æ‹¿åˆ° Token é–‹å§‹æ¸¬è©¦ã€‚*
    ```bash
    npx wrangler d1 execute watch-dog-db --command="INSERT INTO projects (id, token, display_name) VALUES ('topreview', 'secret-123', 'TopReview Edge')"
    ```
5.  **éƒ¨ç½²**:
    `npx wrangler deploy`

é€™å¥—ç³»çµ±ä¸Šç·šå¾Œï¼Œä½ å°‡æ“æœ‰ä¸€å€‹**å…¨è‡ªå‹•åŒ–ã€å…·å‚™å•†æ¥­æ€ç¶­ã€ä¸”æ¥µä½æˆæœ¬**çš„ç›£æ§ä¸­å¿ƒã€‚

---

### 2. çµ¦ Claude Code çš„è‡ªå‹•åŒ–è¨­å®šæŒ‡ä»¤

ä½ å¯ä»¥ç›´æ¥æŠŠä¸‹é¢é€™æ®µè©±å’Œä»£ç¢¼è²¼çµ¦ Claude Codeï¼Œå®ƒå°±èƒ½å¹«ä½ æŠŠç’°å¢ƒå…¨è¨­å®šå¥½ã€‚

#### Prompt çµ¦ Claude Codeï¼š
> ã€Œè«‹ä¾ç…§ä»¥ä¸‹è¦æ ¼é…ç½® `wrangler.toml` å’Œ Worker çš„æ’ç¨‹é€²å…¥é»ã€‚é‡é»æ˜¯è¨­å®š D1 è³‡æ–™åº«ç¶å®šèˆ‡ Cron Triggersï¼Œä¸¦ç¢ºä¿ç¨‹å¼ç¢¼èƒ½æ­£ç¢ºå€åˆ† API è«‹æ±‚èˆ‡æ’ç¨‹è§¸ç™¼ã€‚ã€

---

#### A. é…ç½®æª” (`wrangler.toml`)
é€™æ˜¯æ ¸å¿ƒè¨­å®šï¼ŒåŒ…å« D1 ç¶å®šã€Cron æ’ç¨‹ (æ¯åˆ†é˜ä¸€æ¬¡) èˆ‡ Hono çš„é€²å…¥é»ã€‚

```toml
name = "watch-dog-sentinel"
main = "src/index.tsx"
compatibility_date = "2024-02-02"

# 1. D1 è³‡æ–™åº«ç¶å®š
[[d1_databases]]
binding = "DB"
database_name = "watch-dog-db"
database_id = "è«‹å¡«å…¥_npx_wrangler_d1_create_ç”¢ç”Ÿçš„ID"

# 2. æ’ç¨‹è¨­å®š (Cron Triggers)
# "* * * * *" ä»£è¡¨æ¯åˆ†é˜åŸ·è¡Œä¸€æ¬¡ (Cloudflare æœ€å°å–®ä½)
[triggers]
crons = ["* * * * *"]

# 3. è§€å¯Ÿæ€§è¨­å®š (å¯é¸ï¼Œé™¤éŒ¯ç”¨)
[observability]
enabled = true
```

---

#### B. ç¨‹å¼ç¢¼æ¶æ§‹ (`src/index.tsx`)
é€™æ˜¯ Hono èˆ‡ Cron æ•´åˆçš„æ¨™æº–å¯«æ³•ã€‚Hono è™•ç† HTTP è«‹æ±‚ï¼Œ`scheduled` å‡½å¼è™•ç† Cron äº‹ä»¶ã€‚

```tsx
import { Hono } from 'hono';
import { cors } from 'hono/cors';

// å®šç¾©ç’°å¢ƒè®Šæ•¸ä»‹é¢
type Bindings = {
  DB: D1Database;
};

const app = new Hono<{ Bindings: Bindings }>();

// --- ä¸­ä»‹è»Ÿé«” ---
app.use('*', cors());

// --- API è·¯ç”±å€åŸŸ ---
app.get('/', (c) => c.text('Watch-Dog Sentinel Active ğŸŸ¢'));

app.post('/api/pulse', async (c) => {
    // é€™è£¡æ”¾æ¥æ”¶å¿ƒè·³çš„é‚è¼¯
    return c.json({ status: 'received' });
});

// ... å…¶ä»– API (config, maintenance) ...

// --- åŒ¯å‡ºè¨­å®š (é‡è¦) ---
export default {
  // 1. HTTP è«‹æ±‚è™•ç† (äº¤çµ¦ Hono)
  fetch: app.fetch,

  // 2. Cron æ’ç¨‹è™•ç† (Cloudflare åŸç”Ÿä»‹é¢)
  async scheduled(event: ScheduledEvent, env: Bindings, ctx: ExecutionContext) {
    ctx.waitUntil((async () => {
      console.log(`[Cron] Triggered at ${new Date(event.scheduledTime).toISOString()}`);
      
      // é€™è£¡å‘¼å«ä½ çš„å·¡æª¢é‚è¼¯
      // await runDeadManSwitchCheck(env.DB);
      
      // ç¯„ä¾‹é‚è¼¯ï¼š
      const now = Math.floor(Date.now() / 1000);
      
      // çœŸæ­£çš„å·¡æª¢ SQL
      const { results } = await env.DB.prepare(`
        SELECT * FROM checks 
        WHERE type = 'heartbeat' 
        AND status != 'dead'
        AND (last_seen + interval + grace) < ?
      `).bind(now).all();

      if (results.length > 0) {
          console.log(`[Cron] Found ${results.length} dead checks!`);
          // è§¸ç™¼è­¦å ±é‚è¼¯...
      }

    })());
  },
};
```

### ç¸½çµçµ¦ä½ çš„åŸ·è¡Œæ­¥é©Ÿ

1.  **D1 å»ºç«‹**ï¼šè®“ Claude Code åŸ·è¡Œ `npx wrangler d1 create watch-dog-db`ã€‚
2.  **ID å¡«å…¥**ï¼šè®“å®ƒæŠŠå›å‚³çš„ ID å¡«å…¥ `wrangler.toml`ã€‚
3.  **Schema åŸ·è¡Œ**ï¼šè®“å®ƒåŸ·è¡Œ `npx wrangler d1 execute watch-dog-db --file=src/db.sql` (ä½¿ç”¨æˆ‘å€‘ä¸Šä¸€è¼ªå®šç¾©çš„ Schema)ã€‚
4.  **éƒ¨ç½²**ï¼š`npx wrangler deploy`ã€‚

é€™æ¨£è¨­å®šå¾Œï¼ŒCloudflare é‚Šç·£ç¶²è·¯æ¯åˆ†é˜æœƒè‡ªå‹•å–šé†’ä½ çš„ Worker åŸ·è¡Œ `scheduled` å‡½å¼ï¼Œä¸éœ€ä»»ä½•å¤–éƒ¨ä¼ºæœå™¨ä»‹å…¥ã€‚
